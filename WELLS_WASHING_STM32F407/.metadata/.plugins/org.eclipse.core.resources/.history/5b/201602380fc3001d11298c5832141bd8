/*
 * flash.c
 *
 *  Created on: Mar 15, 2023
 *      Author: ADMIN
 */

#include <stm32f4xx_hal.h>

#define FLASH_PAGE_SIZE         ((uint32_t)0x00000800)   // Flash page size in bytes
#define DATA_SIZE               ((uint32_t)1024)         // Data size in bytes

void write_to_flash(uint8_t data[], uint32_t size, uint32_t address)
{
    FLASH_EraseInitTypeDef EraseInitStruct;
    uint32_t PageError = 0;
    HAL_FLASH_Unlock();

    EraseInitStruct.TypeErase = TYPEERASE_PAGES;
    EraseInitStruct.PageAddress = address;
    EraseInitStruct.NbPages = (size + FLASH_PAGE_SIZE - 1) / FLASH_PAGE_SIZE;

    uint32_t SectorError = 0;
    HAL_FLASHEx_Erase(&EraseInitStruct, &SectorError);

    for (uint32_t i = 0; i < size; i += 4) {
        uint32_t word = data[i] | (data[i+1] << 8) | (data[i+2] << 16) | (data[i+3] << 24);
        HAL_FLASH_Program(TYPEPROGRAM_WORD, address + i, word);
    }

    HAL_FLASH_Lock();
}

